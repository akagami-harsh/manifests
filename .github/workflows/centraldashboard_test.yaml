name: Build & Apply CentralDashboard manifests in KinD
on:
  pull_request:
    paths:
    - tests/gh-actions/install_KinD_create_KinD_cluster_install_kustomize.sh
    - .github/workflows/centraldashboard_test.yaml
    - apps/centraldashboard/upstream/**
    - tests/gh-actions/install_istio*.sh
    - common/istio*/**

jobs:
  test-matrix:
    name: Test on K8s ${{ matrix.k8s_version }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        k8s_version:
          - "v1.32.2"
          - "v1.29.2"
          - "v1.27.10"
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install KinD with Kubernetes ${{ matrix.k8s_version }}
      run: |
        ./tests/gh-actions/install_KinD_create_KinD_cluster_install_kustomize.sh ${{ matrix.k8s_version }}

    - name: Install Istio
      run: ./tests/gh-actions/install_istio.sh

    - name: Create kubeflow namespace
      run: kustomize build common/kubeflow-namespace/base | kubectl apply -f -

    - name: Install central-dashboard
      run: |
        kustomize build apps/centraldashboard/upstream/overlays/kserve | kubectl apply -f -
        kubectl wait --for=condition=Ready pods --all --all-namespaces --timeout 180s
